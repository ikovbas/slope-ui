/**
 * angular-strap
 * @version v2.0.2 - 2014-05-21
 * @link http://mgcrea.github.io/angular-strap
 * @author Olivier Louvignes (olivier@mg-crea.com)
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("mgcrea.ngStrap.typeahead",["mgcrea.ngStrap.tooltip","mgcrea.ngStrap.helpers.parseOptions"]).provider("$typeahead",function(){var e=this.defaults={animation:"am-fade",prefixClass:"typeahead",placement:"bottom-left",template:"typeahead/typeahead.tpl.html",trigger:"focus",container:!1,keyboard:!0,html:!1,delay:0,minLength:1,filter:"filter",limit:6};this.$get=["$window","$rootScope","$tooltip","$parse",function(t,n,a,i){function o(t,n,o){var r={},l=angular.extend({},e,o);r=a(t,l);var c=o.scope,s=r.$scope;s.$resetMatches=function(){s.$matches=[],s.$activeIndex=0},s.$resetMatches(),s.$activate=function(e){s.$$postDigest(function(){r.activate(e)})},s.$select=function(e){s.$$postDigest(function(){r.select(e)})},s.$isVisible=function(){return r.$isVisible()},r.update=function(e){s.$matches=e,s.$activeIndex>=e.length&&(s.$activeIndex=0)},r.activate=function(e){s.$activeIndex=e},r.select=function(e){var t=s.$matches[e].value;if(n.$setViewValue(t),n.$render(),s.$resetMatches(),c&&c.$digest(),s.$emit("$typeahead.select",t,e),l.onSelect){var a=i(l.onSelect);"function"==typeof a&&a(s)}},r.$isVisible=function(){if(!l.minLength||!n)return!!s.$matches.length;var e=angular.isString(n.$viewValue)&&n.$viewValue.length>=l.minLength;return s.$matches.length&&(e||0===parseInt(l.minLength))},r.$getIndex=function(e){var t=s.$matches.length,n=t;if(t){for(n=t;n--&&s.$matches[n].value!==e;);if(!(0>n))return n}},r.$onMouseDown=function(e){e.preventDefault(),e.stopPropagation()},r.$onKeyDown=function(e){/(38|40|13)/.test(e.keyCode)&&(e.preventDefault(),e.stopPropagation(),13===e.keyCode&&s.$matches.length?r.select(s.$activeIndex):38===e.keyCode&&s.$activeIndex>0?s.$activeIndex--:40===e.keyCode&&s.$activeIndex<s.$matches.length-1?s.$activeIndex++:angular.isUndefined(s.$activeIndex)&&(s.$activeIndex=0),s.$digest())};var u=r.show;r.show=function(){u(),setTimeout(function(){r.$element.on("mousedown",r.$onMouseDown),l.keyboard&&t.on("keydown",r.$onKeyDown)})};var $=r.hide;return r.hide=function(){r.$element.off("mousedown",r.$onMouseDown),l.keyboard&&t.off("keydown",r.$onKeyDown),$()},r}angular.element(t.document.body);return o.defaults=e,o}]}).directive("bsTypeahead",["$window","$parse","$q","$typeahead","$parseOptions",function(e,t,n,a,i){var o=a.defaults;return{restrict:"EAC",require:"ngModel",link:function(e,n,r,l){var c={scope:e};angular.forEach(["placement","container","delay","trigger","keyboard","html","animation","template","filter","limit","minLength","onSelect","inputLabel"],function(e){angular.isDefined(r[e])&&(c[e]=r[e])});var s=c.filter||o.filter,u=c.limit||o.limit,$=r.ngOptions;s&&($+=" | "+s+":$viewValue"),u&&($+=" | limitTo:"+u);var d=i($),f=a(n,l,c);e.$watch(r.ngModel,function(t){e.$modelValue=t,d.valuesFn(e,l).then(function(e){e.length>u&&(e=e.slice(0,u)),(1!==e.length||e[0].value!==t)&&(f.update(e),l.$render())})}),l.$render=function(){if("string"==typeof l.$viewValue||f.$scope.$matches.length){if(l.$isEmpty(l.$viewValue))return n.val("");var a=f.$getIndex(l.$modelValue),i="";if(c.inputLabel&&angular.isNumber(a)){var o=t(c.inputLabel);if(i=o(e),!i)return}else i=angular.isDefined(a)?f.$scope.$matches[a].label:l.$viewValue,angular.isObject(i)&&(i=i.label);n.val(i.replace(/<(?:.|\n)*?>/gm,"").trim())}},e.$on("$destroy",function(){f.destroy(),c=null,f=null})}}}]);